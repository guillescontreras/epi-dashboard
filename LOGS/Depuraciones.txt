# üìã REGISTRO DE DEPURACIONES - CoironTech AI EPP Dashboard

## üìä HISTORIAL DE VERSIONES

### ‚úÖ v2.6.0 (MINOR) - 31/10/2025
**PDF completo con im√°genes y branding corporativo**
- ‚úÖ Logo CoironTech en header del PDF
- ‚úÖ Im√°genes comparativas (original vs anotada) lado a lado
- ‚úÖ Footer corporativo con informaci√≥n de contacto
- ‚úÖ Conversi√≥n autom√°tica de URLs S3 a base64
- ‚úÖ CORS configurado en bucket S3 rekognition-gcontreras
- ‚úÖ PDF profesional y completo

**Archivos modificados:**
- `/epi-dashboard/src/utils/pdfGenerator.ts`
- `/epi-dashboard/src/utils/imageToBase64.ts` (nuevo)
- `/epi-dashboard/src/version.ts`
- `/s3-cors-config.json` (nuevo)

**Infraestructura:**
- ‚úÖ CORS habilitado en S3 para carga de im√°genes

---

### ‚úÖ v2.5.9 (PATCH) - 31/10/2025
**Correcciones UX cr√≠ticas (6 de 7)**
- ‚úÖ EPPs seleccionados visibles en historial con badges azules
- ‚úÖ Resultados solo visibles cuando progress === 0 (an√°lisis completo)
- ‚úÖ Eliminados 4 toasts redundantes con emergente verde
- ‚úÖ Bot√≥n feedback movido al final del informe (asistente + historial)
- ‚úÖ Emergente verde limpio sin bot√≥n prematuro
- ‚úÖ UX m√°s clara y menos confusa

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx`
- `/epi-dashboard/src/version.ts`

---

### ‚úÖ v2.5.8 (PATCH) - 31/10/2025
**EPPs seleccionados + bot√≥n reportar errores**
- ‚úÖ Guardar selectedEPPs en an√°lisis (trazabilidad completa)
- ‚úÖ Mostrar EPPs evaluados en PDF
- ‚úÖ Bot√≥n "Reportar Error" en resultados e historial
- ‚úÖ ContactModal acepta initialTab e initialMessage
- ‚úÖ Referencia a imagen analizada en PDF

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx`
- `/epi-dashboard/src/components/ContactModal.tsx`
- `/epi-dashboard/src/utils/pdfGenerator.ts`
- `/epi-dashboard/src/version.ts`

---

### ‚úÖ v2.5.7 (PATCH) - 31/10/2025
**Evaluaci√≥n parcial de EPPs**
- ‚úÖ Persona evaluable si tiene AL MENOS UNA parte visible
- ‚úÖ Permite evaluaci√≥n parcial de EPPs seg√∫n partes visibles
- ‚úÖ Ejemplo: Si selecciona CASCO+GUANTES+CALZADO, eval√∫a cada EPP independientemente

**L√≥gica corregida:**
- Antes: Persona deb√≠a tener TODAS las partes para TODOS los EPPs ‚Üí demasiado estricto
- Ahora: Persona evaluable si tiene AL MENOS UNA parte de los EPPs requeridos

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx` - Funci√≥n `generateLocalAISummary()`
- `/bedrock-summary-lambda.py` - Funci√≥n `is_evaluable_person()`

---

### ‚úÖ v2.5.6 (PATCH) - 31/10/2025
**Filtrado din√°mico correcto seg√∫n EPPs requeridos**
- ‚úÖ Fix: Error de sintaxis en version.ts
- ‚úÖ Filtrado din√°mico de personas evaluables
- ‚úÖ L√≥gica: Persona evaluable si tiene partes visibles para EPPs requeridos

**Archivos modificados:**
- `/epi-dashboard/src/version.ts`
- `/epi-dashboard/src/App.tsx`
- `/bedrock-summary-lambda.py`

---

### ‚úÖ v2.5.2 (PATCH) - 31/10/2025
**Modo avanzado deshabilitado temporalmente**
- ‚úÖ Desactivaci√≥n temporal del modo avanzado
- ‚úÖ Bot√≥n reemplazado por mensaje: "‚ö†Ô∏è Modo Avanzado temporalmente deshabilitado"
- ‚úÖ Usuarios solo pueden usar Asistente de An√°lisis (modo guiado)

**Problema detectado:**
- An√°lisis desde modo avanzado no se guardaban correctamente en DynamoDB
- Inconsistencias en historial
- P√©rdida de datos de an√°lisis

---

### ‚úÖ v2.5.0 - v2.5.1 (MINOR/PATCH) - 31/10/2025
**Formulario de contacto + FAQ + Feedback**
- ‚úÖ Formulario de contacto con 3 tabs (Contacto, Feature Request, Bug Report)
- ‚úÖ Secci√≥n FAQ con 12 preguntas frecuentes
- ‚úÖ Sistema de feedback post-an√°lisis
- ‚úÖ Lambda contact-submission con DynamoDB y SES
- ‚úÖ Correcciones cr√≠ticas en modo avanzado y evaluaci√≥n EPP

---

### ‚úÖ v2.4.0 - v2.4.3 (MINOR/PATCH) - 30/10/2025
**Listas geogr√°ficas + validaci√≥n de seguridad**
- ‚úÖ Listas geogr√°ficas en cascada para perfil de usuario
- ‚úÖ Validaci√≥n de seguridad en Lambdas + Rate limiting
- ‚úÖ Sistema de feedback post-an√°lisis

---

### ‚úÖ v2.3.0 - v2.3.3 (MINOR/PATCH) - 29/10/2025
**Res√∫menes IA + correcciones cr√≠ticas**
- ‚úÖ Res√∫menes IA con Claude 3 Haiku (Amazon Bedrock)
- ‚úÖ Exportaci√≥n PDF con nombre √∫nico
- ‚úÖ Eliminar an√°lisis del historial
- ‚úÖ Deshabilitar PDF en an√°lisis no-EPP
- ‚úÖ Edici√≥n de perfil desde men√∫ usuario

---

### ‚úÖ v2.2.0 (MINOR) - 28/10/2025
**Integraci√≥n completa con AWS**
- ‚úÖ AWS Cognito para autenticaci√≥n
- ‚úÖ DynamoDB para almacenamiento de an√°lisis
- ‚úÖ Lambda para operaciones backend
- ‚úÖ API Gateway para endpoints REST

---

### ‚úÖ v2.0.0 - v2.1.1 (MAJOR/MINOR) - 27/10/2025
**Redise√±o completo + an√°lisis de video**
- ‚úÖ Redise√±o completo con branding CoironTech
- ‚úÖ An√°lisis de video y detecci√≥n en tiempo real
- ‚úÖ Optimizaciones de UX y flujo del asistente

---

## üêõ BUGS PENDIENTES (BACKLOG)

### üî¥ ALTA PRIORIDAD

#### Modo Avanzado - Redise√±o completo (v2.7.0 - MINOR)
**Estado:** Deshabilitado temporalmente desde v2.5.2
**Problema:** Inconsistencias en guardado de an√°lisis en DynamoDB
**Soluci√≥n propuesta:**
- Revisar flujo de guardado en DynamoDB
- Sincronizar estados entre modo avanzado y historial
- Implementar validaci√≥n de guardado exitoso
- Agregar feedback visual de guardado
- Testing exhaustivo antes de reactivar

---

### üü° MEDIA PRIORIDAD

#### ‚úÖ Backend de Feedback - COMPLETADO
**Estado:** Funcional
**Implementado:**
- ‚úÖ Lambda feedback-submission creada y desplegada
- ‚úÖ Tabla DynamoDB UserFeedback
- ‚úÖ API Gateway endpoint /feedback configurado
- ‚úÖ Permisos IAM configurados
- ‚úÖ Probado exitosamente

**Archivos creados:**
- `/feedback-submission-lambda.py`
- `/feedback-submission-lambda.zip`

---

#### FAQ - Menci√≥n de servicios espec√≠ficos (v2.6.1 - PATCH)
**Estado:** Pendiente
**Problema:** FAQ menciona "Amazon Rekognition" (servicio espec√≠fico)
**Soluci√≥n propuesta:**
- Actualizar respuesta "¬øC√≥mo funciona la detecci√≥n de EPP?"
- Mencionar: Tecnolog√≠a de IA (gen√©rico), soporte AWS, mejora continua
- NO mencionar: Rekognition, TensorFlow.js, Bedrock

**Archivo:** `/epi-dashboard/src/components/FAQ.tsx` (l√≠nea ~18-20)

---

## üìù NOTAS Y OBSERVACIONES

### Infraestructura AWS

#### DynamoDB Tables
- **UserProfiles:** Perfiles de usuario con datos geogr√°ficos
- **epi-user-analysis:** Historial de an√°lisis con selectedEPPs
- **ContactMessages:** Mensajes de contacto (3 tipos)
- **UserFeedback:** Feedback de usuarios (pendiente backend)

#### Lambdas
- **user-profile:** Gesti√≥n de perfiles de usuario
- **delete-analysis:** Eliminaci√≥n de an√°lisis del historial
- **contact-submission:** Procesamiento de mensajes de contacto
- **feedback-submission:** Procesamiento de feedback (pendiente)
- **bedrock-summary:** Res√∫menes IA con Claude 3 Haiku

#### API Gateway
- **REST API:** n0f5jga1wc
- **Endpoints:** /user-profile, /delete, /contact, /feedback

#### S3 Buckets
- **rekognition-gcontreras:** Almacenamiento de im√°genes
  - ‚úÖ CORS habilitado para carga en PDF
  - Carpetas: /input, /output

---

### Configuraci√≥n de Dominio
- **Servidor:** Lightsail con WordPress
- **Dominio:** www.coirontech.com
- **Pendiente:** Configurar subdominio para la app

---

### Mejoras Implementadas en v2.5.x - v2.6.0

#### Filtrado Inteligente de Personas
- Evaluaci√≥n parcial seg√∫n partes del cuerpo visibles
- Filtrado din√°mico seg√∫n EPPs seleccionados
- Validaci√≥n EPP-BodyPart coherente
- M√©tricas precisas de cumplimiento

#### UX Mejorada
- EPPs visibles en historial con badges
- Timing correcto de visualizaci√≥n de resultados
- Feedback reposicionado al final del informe
- Eliminaci√≥n de notificaciones redundantes

#### PDF Profesional
- Logo corporativo en header
- Im√°genes comparativas (original vs anotada)
- Footer con informaci√≥n de contacto
- EPPs seleccionados listados
- Normas OSHA e ISO 45001

---

## üéØ ROADMAP FUTURO

### üî¥ PRIORIDAD ALTA

#### v2.6.17 (PATCH) - An√°lisis detallado muestra todos los EPPs sin filtrar por umbral
**Estado:** ‚úÖ Completado
**Problema:** Al cambiar umbral de 50% a 75%, elementos detectados al 50-74% desaparecen del an√°lisis detallado por persona
**Soluci√≥n implementada:**
- Lambda modificada para usar MinConfidence fijo de 50%
- Rekognition devuelve TODAS las detecciones ‚â•50%
- Umbral del usuario solo afecta estado en frontend
- **Tiempo real:** 30 min

#### ‚úÖ Badges de EPP con colores seg√∫n estado - COMPLETADO
**Estado:** Resuelto en v2.8.0
**Problema:** En resumen de an√°lisis, badges de EPP seleccionados no diferencian visualmente su estado
**Soluci√≥n propuesta:**
- üü¢ Verde: EPP detectado y cumple con umbral de confianza
- üü° Amarillo: EPP detectado pero NO cumple con umbral
- üî¥ Rojo: EPP NO detectado
- **Estimado:** 30 min

#### Dashboard no coincide con historial
**Estado:** Pendiente
**Problema:** An√°lisis recientes en dashboard no coinciden con los del historial
**Soluci√≥n propuesta:**
- Revisar query de DynamoDB en dashboard
- Verificar ordenamiento por timestamp
- Asegurar consistencia entre ambas vistas
- **Estimado:** 30 min

#### ‚úÖ ID √∫nico de an√°lisis - COMPLETADO
**Estado:** Resuelto en v2.8.0
**Problema:** No exist√≠a identificador √∫nico visible para cada an√°lisis
**Soluci√≥n implementada:**
- Campo `analysisId` (UUID) agregado en cada an√°lisis
- ID visible en informe, PDF y historial
- Guardado en DynamoDB

#### Formulario de contacto unificado con autocompletado
**Estado:** Pendiente
**Problema:** Bot√≥n "Reportar Error" no lleva a formulario unificado ni autocompleta datos
**Soluci√≥n propuesta:**
- Crear formulario √∫nico de contacto con desplegable:
  - Contacto general
  - Reporte de bug
  - Solicitar caracter√≠stica
  - Soporte t√©cnico
- Campos: nombre, email, tipo, analysisId, mensaje
- Bot√≥n "Reportar Error" autocompleta:
  - Nombre del usuario (desde Cognito)
  - Email del usuario
  - ID del an√°lisis actual
  - Tipo: "Reporte de bug" (preseleccionado)
- **Estimado:** 1-1.5 horas

#### Optimizaci√≥n m√≥vil de botones en historial
**Estado:** Pendiente
**Problema:** Botones se ven muy grandes en m√≥vil al abrir informes desde historial
**Soluci√≥n propuesta:**
- Media queries para reducir tama√±o de botones en m√≥vil
- Ajustar padding y font-size
- Mejorar espaciado entre elementos
- **Estimado:** 30 min

#### Estilo diferenciado para aclaraciones en informe IA
**Estado:** Pendiente
**Problema:** Explicaciones de personas no evaluables y recomendaciones se ven como parte del informe
**Soluci√≥n propuesta:**
- Aplicar estilo de "cita" o "nota" a:
  - Explicaci√≥n de personas no evaluables
  - Recomendaciones para mejorar detecci√≥n
- Opciones: borde izquierdo, fondo gris claro, fuente italic, √≠cono de info
- **Estimado:** 30 min

#### Recorte de imagen por persona en an√°lisis detallado
**Estado:** Pendiente
**Problema:** Tabla de an√°lisis detallado no muestra visualmente a qu√© persona se refiere
**Soluci√≥n propuesta:**
- Agregar columna con recorte de imagen de cada persona
- Usar coordenadas del bounding box de la persona
- Mostrar miniatura (ej: 80x80px)
- **Estimado:** 1-1.5 horas

#### ‚úÖ Tooltip explicativo en selector de confianza m√≠nima - COMPLETADO
**Estado:** Resuelto en v2.6.18
**Problema:** Usuario no entend√≠a que el umbral de 50% es fijo para detecci√≥n
**Soluci√≥n implementada:**
- Mensaje informativo agregado en componentes de an√°lisis
- Explica que Rekognition usa 50% fijo y el umbral del usuario solo afecta el estado

---

### üü° PRIORIDAD MEDIA

#### v2.7.0 (MINOR) - Redise√±o Modo Avanzado
- Reactivar modo avanzado con guardado correcto
- Sincronizaci√≥n de estados
- Validaci√≥n de guardado
- Testing exhaustivo
- **Estimado:** 3-4 horas

---

#### v2.6.26 (PATCH) - Correcciones menores
- Backend de feedback funcional
- FAQ sin menciones de servicios espec√≠ficos
- **Estimado:** 1 hora

#### v3.0.0 (MAJOR) - Panel de Administrador
- Dashboard de m√©tricas globales
- Gesti√≥n de usuarios
- Reportes consolidados
- Configuraci√≥n de sistema
- **Estimado:** 8-10 horas

#### v3.1.0 (MINOR) - Modo Inspecci√≥n de Sitio
- An√°lisis por lotes mejorado
- Geolocalizaci√≥n de an√°lisis
- Reportes por ubicaci√≥n
- Exportaci√≥n masiva
- **Estimado:** 4-6 horas

#### v3.2.0 (MINOR) - Notificaciones y Tutoriales
- Notificaciones por email (SES)
- Tutoriales interactivos
- An√°lisis de uso (Pinpoint/Analytics)
- **Estimado:** 3-4 horas

---

### üü¢ PRIORIDAD BAJA

#### v4.0.0 (MAJOR) - Soporte Multiling√ºe
- react-i18next
- Idiomas: Espa√±ol, Ingl√©s, Portugu√©s
- Traducci√≥n de UI y res√∫menes IA
- **Estimado:** 6-8 horas

#### v4.1.0 (MINOR) - Seguridad Avanzada
- MFA con Cognito (SMS/TOTP)
- Opcional para usuarios
- Obligatorio para admins
- **Estimado:** 2-3 horas

#### v4.1.1 (PATCH) - Optimizaci√≥n M√≥vil
- Lazy loading de componentes
- Compresi√≥n de im√°genes
- Service Workers para PWA
- Cach√© de resultados
- **Estimado:** 3-4 horas

---

## üîß INFRAESTRUCTURA PENDIENTE

### Sistema de Backups Autom√°ticos
- DynamoDB Point-in-Time Recovery
- Backups diarios a S3
- Retenci√≥n de 30 d√≠as
- **Complejidad:** üü¢ Baja (30 min)
- **Impacto:** üü¢ Alto (protecci√≥n de datos)

### Pruebas de Usabilidad
- Contratar 5-10 usuarios beta
- Sesiones de testing moderadas
- Heatmaps con Hotjar
- Identificar pain points
- **Complejidad:** N/A (proceso externo)
- **Impacto:** üü¢ Alto (mejora continua)

---

## üìå CONVENCIONES

### Versionado Sem√°ntico
- **MAJOR (X.0.0):** Cambios incompatibles, redise√±os completos
- **MINOR (x.X.0):** Nuevas funcionalidades compatibles
- **PATCH (x.x.X):** Correcciones de bugs, mejoras menores

### Prioridades
- üî¥ **ALTA:** Cr√≠tico, afecta funcionalidad core
- üü° **MEDIA:** Importante, mejora experiencia
- üü¢ **BAJA:** Nice to have, evaluar demanda

### Complejidad
- üü¢ **Baja:** < 1 hora
- üü° **Media:** 1-3 horas
- üü† **Alta:** > 3 horas

---

## üìà M√âTRICAS DE PROGRESO

### Sesi√≥n 31/10/2025
- **Versiones desplegadas:** v2.5.6 ‚Üí v2.6.0 (5 versiones)
- **Bugs corregidos:** 7 cr√≠ticos UX/UI
- **Features implementadas:** 3 (EPPs en historial, PDF completo, feedback reposicionado)
- **Infraestructura:** CORS configurado en S3
- **Tiempo total:** ~4 horas

### Estado General del Proyecto
- **Versi√≥n actual:** v2.6.0
- **Bugs cr√≠ticos pendientes:** 1 (Modo avanzado)
- **Bugs media prioridad:** 2 (Backend feedback, FAQ)
- **Features planificadas:** 10+ en roadmap
- **Estabilidad:** ‚úÖ Alta (modo guiado funcional)

---

### ‚úÖ v2.6.4 (PATCH) - 31/10/2025
**Fix cr√≠tico: Tabla EPP visible inmediatamente + PDF imagen √∫nica**
- ‚úÖ Eliminada condici√≥n `progress === 0` que imped√≠a mostrar tabla EPP despu√©s del an√°lisis
- ‚úÖ PDF ahora muestra solo imagen original (una vez) en lugar de duplicarla
- ‚úÖ Comentarios agregados indicando que imagen anotada requiere modificaci√≥n de Lambda

**Problema resuelto:**
- Tabla "Detalles de EPP Detectado" no aparec√≠a despu√©s del an√°lisis (solo en PDF/historial)
- PDF mostraba la misma imagen dos veces

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx` - Eliminada condici√≥n progress === 0
- `/epi-dashboard/src/utils/pdfGenerator.ts` - PDF con imagen √∫nica
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.4

---

### ‚úÖ v2.6.5 (PATCH) - 31/10/2025
**Fix cr√≠tico: Tabla EPP muestra todas las detecciones**
- ‚úÖ Eliminado filtrado restrictivo en tabla "Detalles de EPP Detectado"
- ‚úÖ Ahora muestra TODAS las personas detectadas con TODOS sus EPPs
- ‚úÖ NO afecta detecci√≥n, resumen IA, m√©tricas ni PDF

**Problema resuelto:**
- Tabla "Detalles de EPP Detectado" no mostraba filas despu√©s del an√°lisis
- Filtrado demasiado estricto bloqueaba visualizaci√≥n

**Archivos modificados:**
- `/epi-dashboard/src/components/ImageComparison.tsx` - Simplificado l√≥gica de tabla
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.5

**Nota importante:** Este cambio solo afecta la visualizaci√≥n de la tabla. La l√≥gica de evaluaci√≥n de personas, c√°lculo de cumplimiento y resumen IA permanecen intactos en App.tsx y bedrock-summary-lambda.py

---

### ‚úÖ v2.6.15 (PATCH) - 02/11/2025
**Fix cr√≠tico: Tabla muestra TODOS los EPPs detectados, umbral solo determina Cumple/No cumple**
- ‚úÖ Tabla ahora muestra TODOS los elementos detectados sin filtrar por umbral
- ‚úÖ Umbral solo determina el ESTADO: Cumple % / No cumple % / No detectado / No evaluable
- ‚úÖ Estados actualizados:
  - ‚úÖ **Cumple X%** (verde): EPP detectado ‚â• umbral configurado
  - ‚ùå **No cumple X%** (rojo): EPP detectado < umbral configurado
  - ‚ùå **No detectado** (rojo): EPP no encontrado (0%)
  - ‚ö†Ô∏è **No evaluable** (gris): Parte del cuerpo no visible
- ‚úÖ Contexto de IA actualizado para incluir todos los elementos detectados
- ‚úÖ PDF actualizado con misma l√≥gica de estados

**Problema resuelto:**
- Usuario report√≥ que tabla no mostraba elementos con porcentaje bajo umbral
- Sistema ocultaba EPPs detectados que no cumpl√≠an el umbral
- Ahora muestra TODOS los detectados, el umbral solo afecta el estado

**Archivos modificados:**
- `/epi-dashboard/src/components/ImageComparison.tsx` - Estados actualizados
- `/epi-dashboard/src/utils/pdfGenerator.ts` - Estados en PDF
- `/epi-dashboard/src/App.tsx` - Contexto IA actualizado
- `/bedrock-summary-lambda.py` - Prompt actualizado
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.15

---

### ‚úÖ v2.6.16 (PATCH) - 02/11/2025
**Fix cr√≠tico: Anotaciones visuales muestran TODOS los EPPs detectados**
- ‚úÖ Eliminado filtro de `minConfidence` en anotaciones visuales (boxes en imagen)
- ‚úÖ Ahora se dibujan boxes para TODOS los EPPs detectados, sin importar el porcentaje
- ‚úÖ Color verde si cumple umbral, rojo si no cumple
- ‚úÖ Leyenda actualizada: EPP No Cumple en rojo

**Problema resuelto:**
- Usuario report√≥ que al cambiar umbral de 50% a 75%, elementos detectados al 69% desaparec√≠an de la imagen
- Filtro en l√≠nea 80-81 de ImageComparison.tsx ocultaba EPPs bajo umbral
- Ahora TODOS los elementos detectados se muestran visualmente

**Archivos modificados:**
- `/epi-dashboard/src/components/ImageComparison.tsx` - Eliminado filtro minConfidence en anotaciones
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.16

---

### ‚úÖ v2.6.17 (PATCH) - 03/11/2025
**Fix cr√≠tico: Lambda siempre detecta con MinConfidence 50%, umbral usuario solo afecta estado**
- ‚úÖ Lambda `rekognition-processor` modificada para usar MinConfidence fijo de 50%
- ‚úÖ AWS Rekognition ahora devuelve TODAS las detecciones con confianza ‚â•50%
- ‚úÖ Umbral configurado por usuario solo se usa en frontend para determinar estado (Cumple/No cumple)
- ‚úÖ Tabla de an√°lisis detallado muestra TODOS los EPPs detectados independiente del umbral

**Problema resuelto:**
- Usuario report√≥: an√°lisis al 75% no mostraba calzado detectado al 69% en tabla detallada
- Al cambiar a 50%, el calzado aparec√≠a
- Causa ra√≠z: Lambda pasaba `minConfidence` del usuario a Rekognition, filtrando resultados
- Soluci√≥n: Lambda siempre usa 50% fijo, frontend aplica umbral del usuario solo para estados

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs` - MinConfidence fijo en 50%
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.17

**Despliegues:**
- ‚úÖ Lambda `rekognition-processor` actualizada v√≠a AWS CLI
- ‚úÖ Frontend v2.6.17 pusheado a GitHub (Amplify auto-deploy)

---

### ‚úÖ v2.6.17 - RESTAURACI√ìN CR√çTICA (03/11/2025)
**INCIDENTE CR√çTICO: Lambda rekognition-processor rota por modificaciones sin backup**

**Problema:**
- Se modific√≥ Lambda rekognition-processor sin hacer backup previo
- Se intent√≥ cambiar MinConfidence a 50% fijo
- Se rompi√≥ la estructura de respuesta que el frontend esperaba
- Aplicaci√≥n completamente inoperativa por ~45 minutos

**Causa ra√≠z:**
- Lambda NO devolv√≠a campo `presignedUrl` que el frontend requiere (l√≠neas 591-597 de App.tsx)
- Frontend hace `axios.get(presignedUrl)` para obtener JSON con resultados
- Sin presignedUrl ‚Üí error "cannot read properties of undefined (reading 'protocol')"

**Soluci√≥n implementada:**
- Lambda ahora guarda resultados en S3 como JSON (`web/${baseName}_${timestamp}.json`)
- Genera presignedUrl usando `getSignedUrl` de AWS SDK
- Devuelve respuesta con presignedUrl incluido
- Frontend obtiene JSON desde S3 usando presignedUrl

**Estructura correcta de respuesta Lambda:**
```javascript
{
  ProtectiveEquipment: [...],
  Summary: { totalPersons, compliant, minConfidence },
  DetectionType: 'ppe_detection',
  presignedUrl: 'https://rekognition-gcontreras.s3...'
}
```

**Archivos cr√≠ticos:**
- Lambda: `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`
- Frontend: `/epi-dashboard/src/App.tsx` (l√≠neas 591-597)
- Backup Lambda v4: `function-v4.zip` (versi√≥n S3 trigger, NO compatible con invocaci√≥n directa)

**Lecciones aprendidas:**
1. ‚ö†Ô∏è SIEMPRE hacer backup antes de modificar Lambda
2. ‚ö†Ô∏è NUNCA modificar frontend sin autorizaci√≥n expl√≠cita
3. ‚ö†Ô∏è Documentar estructura de respuesta esperada
4. ‚ö†Ô∏è Verificar versiones de Lambda en AWS antes de restaurar
5. ‚ö†Ô∏è Lambda v4 es para S3 triggers, NO para invocaci√≥n directa

**Tiempo de resoluci√≥n:** ~45 minutos
**Impacto:** Aplicaci√≥n completamente inoperativa
**Estado final:** ‚úÖ Restaurado y funcionando

---

### ‚úÖ SISTEMA DE BACKUPS IMPLEMENTADO (01/11/2025)
**Infraestructura de respaldo completa para EPI CoironTech**

**Problema:**
- Incidente cr√≠tico previo demostr√≥ necesidad de backups robustos
- No exist√≠a sistema automatizado de respaldo
- Riesgo de p√©rdida de infraestructura completa

**Soluci√≥n implementada:**

#### 1. Backup Local (backup-complete.sh)
- Descarga toda la infraestructura de AWS a Mac local
- Respalda: 3 Lambdas (19MB total), S3 config, 2 APIs, Amplify, IAM roles
- Genera template CloudFormation para recrear infraestructura
- Ubicaci√≥n: `/infrastructure/backup-complete.sh`
- Uso: `./backup-complete.sh`

#### 2. AWS Backup Autom√°tico (aws-backup-setup.sh)
- Backups diarios autom√°ticos en la nube a las 5:00 AM UTC
- Vault: EPI-CoironTech-Vault
- Retenci√≥n: 30 d√≠as
- Recursos: rekognition-processor, upload-presigned, bedrock-summary
- Versionado S3 habilitado en rekognition-gcontreras
- Ubicaci√≥n: `/infrastructure/aws-backup-setup.sh`

**Primer backup ejecutado:**
- Fecha: 01/11/2025 17:07
- Lambdas: 3/3 ‚úÖ (rekognition-processor 19MB, upload-presigned 818B, bedrock-summary 4.1KB)
- APIs: 2/2 ‚úÖ
- Amplify: 1/1 ‚úÖ

**AWS Backup configurado:**
- Vault ARN: arn:aws:backup:us-east-1:825765382487:backup-vault:EPI-CoironTech-Vault
- Plan ID: 1ddada9a-f290-4ced-8752-ed2231921e5a
- Estado: ‚úÖ Activo

**Estrategia:**
1. Autom√°tico diario: AWS Backup en nube
2. Manual pre-cambios: backup-complete.sh
3. Versionado S3: Protecci√≥n archivos bucket

**Restauraci√≥n:**
- Local: `aws lambda update-function-code --zip-file fileb://lambdas/nombre.zip`
- CloudFormation: `aws cloudformation create-stack --template-body file://epi-infrastructure.yaml`
- AWS Backup: Desde consola AWS

**Archivos creados:**
- `/infrastructure/backup-complete.sh` (20 KB)
- `/infrastructure/aws-backup-setup.sh` (5.3 KB)
- `/infrastructure/README.md` (7.4 KB)
- `/backups-epi/20251101-170710/` (primer backup)

---

### ‚úÖ v2.6.18 (PATCH) - 01/11/2025
**Fix definitivo: Lambda usa MinConfidence 50 fijo para Rekognition**
- ‚úÖ Lambda modificada para usar `rekognitionMinConfidence = 50` fijo
- ‚úÖ Rekognition devuelve TODAS las detecciones con confianza ‚â•50%
- ‚úÖ Umbral del usuario (minConfidence) se mantiene en Summary para frontend
- ‚úÖ Frontend recibe todos los EPPs y aplica umbral solo para estado visual

**Problema resuelto:**
- Usuario reportaba que al configurar umbral 75%, elementos detectados al 69% no aparec√≠an
- Lambda estaba pasando umbral del usuario a Rekognition, filtrando resultados prematuramente
- Ahora Lambda siempre pide detecciones ‚â•50%, frontend decide qu√© mostrar como Cumple/No cumple

**Ejemplo de funcionamiento:**
- Usuario configura umbral: 75%
- Lambda llama Rekognition con MinConfidence: 50
- Rekognition devuelve: casco 95%, chaleco 82%, calzado 69%
- Frontend recibe los 3 elementos
- Frontend muestra: casco ‚úÖ Cumple 95%, chaleco ‚úÖ Cumple 82%, calzado ‚ùå No cumple 69%

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs` - MinConfidence fijo en 50
- `/epi-dashboard/src/version.ts` - Actualizado a v2.6.18
- `/epi-dashboard/src/components/GuidedAnalysisWizard.tsx` - Mensaje informativo agregado
- `/epi-dashboard/src/components/AnalysisSection.tsx` - Mensaje informativo agregado
- `/epi-dashboard/src/components/ModernAnalysisPanel.tsx` - Mensaje informativo agregado

**Despliegues:**
- ‚úÖ Lambda `rekognition-processor` actualizada v√≠a AWS CLI (01/11/2025 20:18)
- ‚úÖ Backup previo disponible en `backups-epi/20251101-170710/`

**Diferencia con v2.6.17:**
- v2.6.17 intent√≥ el fix pero rompi√≥ presignedUrl (incidente cr√≠tico)
- v2.6.18 implementa el fix correctamente manteniendo estructura de respuesta

---

### ‚úÖ v2.7.0 (MINOR) - 01/11/2025
**Feature: Detecci√≥n H√≠brida de EPPs (Nativa + Labels)**
- ‚úÖ Lambda usa DetectProtectiveEquipment + DetectLabels simult√°neamente
- ‚úÖ EPPs nativos: Casco, Guantes, Mascarilla (alta precisi√≥n)
- ‚úÖ EPPs por labels: Gafas, Calzado, Orejeras (precisi√≥n media)
- ‚úÖ Componente EPPDetectionInfo muestra m√©todos de detecci√≥n
- ‚úÖ Constantes eppDetectionCapabilities.ts con metadata de cada EPP
- ‚úÖ Badges de confianza: Alta (verde), Media (amarillo), Baja (naranja)

**Problema resuelto:**
- AWS Rekognition DetectProtectiveEquipment solo detecta 3 tipos de EPP nativamente
- Usuario necesita detectar 6 tipos: casco, gafas, guantes, calzado, mascarilla, orejeras
- Gafas, calzado y orejeras no eran detectables

**Soluci√≥n implementada:**
- Detecci√≥n h√≠brida: PPE nativo + Labels para EPPs faltantes
- Mapeo de labels: Glasses/Goggles ‚Üí EYE_COVER, Footwear/Boots ‚Üí FOOT_COVER, Headphones ‚Üí EAR_COVER
- Transparencia: UI muestra m√©todo de detecci√≥n y nivel de confianza para cada EPP
- Advertencia: EPPs por labels requieren validaci√≥n visual adicional

**Mapeo de Labels a EPPs:**
```javascript
EYE_COVER: ['Glasses', 'Goggles', 'Sunglasses', 'Safety Glasses', 'Eyewear']
FOOT_COVER: ['Footwear', 'Shoe', 'Shoes', 'Boot', 'Boots', 'Safety Boots']
EAR_COVER: ['Headphones', 'Earmuffs', 'Ear Protection', 'Hearing Protection']
```

**Archivos creados:**
- `/epi-dashboard/src/constants/eppDetectionCapabilities.ts` - Metadata de EPPs
- `/epi-dashboard/src/components/EPPDetectionInfo.tsx` - Componente informativo

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs` - Detecci√≥n h√≠brida
- `/epi-dashboard/src/components/GuidedAnalysisWizard.tsx` - Componente EPPDetectionInfo agregado
- `/epi-dashboard/src/version.ts` - Actualizado a v2.7.0

**Despliegues:**
- ‚úÖ Lambda `rekognition-processor` actualizada (01/11/2025 20:43)
- ‚úÖ Backup previo: index.mjs.backup-v2.6.18-20251101-174202

**Estructura de respuesta Lambda actualizada:**
```javascript
{
  ProtectiveEquipment: [...], // Incluye EPPs de ambos m√©todos
  Summary: {
    totalPersons: N,
    compliant: N,
    minConfidence: 75,
    hybridDetection: true,
    detectionMethods: {
      native: ['HEAD_COVER', 'HAND_COVER', 'FACE_COVER'],
      labels: ['EYE_COVER', 'FOOT_COVER', 'EAR_COVER']
    }
  },
  DetectionType: 'ppe_detection',
  presignedUrl: '...'
}
```

**Indicador de m√©todo en detecciones:**
- EPPs nativos: Sin campo DetectionMethod
- EPPs por labels: DetectionMethod: 'LABEL_DETECTION'

---

### ‚úÖ v2.7.2 (PATCH) - 02/11/2025
**Fix: Mapeo LEFT_FOOT/RIGHT_FOOT para mostrar calzado en tabla**
- ‚úÖ Actualizado mapeo en ImageComparison.tsx l√≠nea 596
- ‚úÖ FOOT_COVER ahora busca: ['FOOT', 'LEFT_FOOT', 'RIGHT_FOOT']
- ‚úÖ Tabla detallada muestra calzado cuando Lambda crea LEFT_FOOT

**Problema resuelto:**
- Lambda creaba LEFT_FOOT pero tabla solo buscaba FOOT
- Calzado detectado no aparec√≠a en tabla por mapeo incompleto

**Archivos modificados:**
- `/epi-dashboard/src/components/ImageComparison.tsx` - Mapeo actualizado
- `/epi-dashboard/src/version.ts` - v2.7.2

---

### ‚ùå v2.7.3 (PATCH) - 02/11/2025 - FALLIDA
**Intento: Detecci√≥n espacial IoU para EPPs h√≠bridos**
- ‚ùå Implementada funci√≥n calculateIoU (Intersection over Union)
- ‚ùå Verificaci√≥n de solapamiento entre BoundingBox de EPP y persona
- ‚ùå Umbral IoU > 0.1 (10%)
- ‚ùå RESULTADO: Bloque√≥ todos los EPPs h√≠bridos (IoU muy bajo 0.002-0.028)

**Problema:**
- L√≥gica IoU comparaba BoundingBox peque√±o (calzado) con BoundingBox grande (persona completa)
- Solapamiento siempre era m√≠nimo
- Ning√∫n EPP h√≠brido pasaba el umbral

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`

**Estado:** Revertido en v2.7.6

---

### ‚ùå v2.7.4 (PATCH) - 02/11/2025 - FALLIDA
**Intento: B√∫squeda exacta de labels**
- ‚úÖ Cambio de `.includes()` a `===` para comparaci√≥n exacta
- ‚ùå No resolvi√≥ el problema (IoU segu√≠a bloqueando)

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`

---

### ‚ùå v2.7.5 (PATCH) - 02/11/2025 - FALLIDA
**Intento: Priorizar labels con instancias**
- ‚úÖ Buscar todos los labels coincidentes con `.filter()`
- ‚úÖ Elegir el que tenga instancias con `.find()`
- ‚ùå No resolvi√≥ el problema (IoU segu√≠a bloqueando)

**L√≥gica:**
- Encontraba "Footwear" (sin instancias) y "Shoe" (con instancias)
- Priorizaba "Shoe" correctamente
- Pero IoU bloqueaba la asignaci√≥n a personas

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`

---

### ‚úÖ v2.7.6 (PATCH) - 02/11/2025
**Fix CR√çTICO: Eliminar l√≥gica IoU - restaurar funcionalidad**
- ‚úÖ Eliminada completamente funci√≥n calculateIoU
- ‚úÖ Eliminada verificaci√≥n de solapamiento
- ‚úÖ Restaurado comportamiento anterior que funcionaba
- ‚úÖ Aplicaci√≥n operativa nuevamente

**Problema resuelto:**
- L√≥gica IoU (v2.7.3-v2.7.5) bloqueaba todos los EPPs h√≠bridos
- Aplicaci√≥n completamente inoperativa para detecci√≥n h√≠brida
- Usuario report√≥ problema cr√≠tico

**Resultado:**
- ‚úÖ Boxes se dibujan correctamente en imagen
- ‚ùå EPPs se agregan a TODAS las personas (sin verificaci√≥n espacial)

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`

**Despliegue:**
- ‚úÖ Lambda actualizada: 2025-11-01T22:50:27Z

---

### ‚úÖ v2.7.7 (PATCH) - 02/11/2025 - FUNCIONAL
**Fix DEFINITIVO: Verificaci√≥n espacial correcta (como EPPs nativos)**
- ‚úÖ Funci√≥n `isInsideBox()` verifica si centro del EPP est√° dentro de persona
- ‚úÖ Filtra instances que est√°n dentro del BoundingBox de cada persona
- ‚úÖ Solo agrega EPP si hay instance dentro de esa persona espec√≠fica
- ‚úÖ L√≥gica similar a DetectProtectiveEquipment nativo

**Problema resuelto:**
- v2.7.6 agregaba EPPs a todas las personas sin discriminar
- Usuario report√≥: "calzado se repite en ambas personas cuando solo una lo tiene"
- Necesitaba verificaci√≥n espacial pero bien implementada

**Soluci√≥n implementada:**
```javascript
const isInsideBox = (innerBox, outerBox) => {
  const innerCenterX = innerBox.Left + innerBox.Width / 2;
  const innerCenterY = innerBox.Top + innerBox.Height / 2;
  
  return innerCenterX >= outerBox.Left && 
         innerCenterX <= outerBox.Left + outerBox.Width &&
         innerCenterY >= outerBox.Top && 
         innerCenterY <= outerBox.Top + outerBox.Height;
};

// Filtrar instances dentro de esta persona
const instancesInPerson = matchedLabel.Instances.filter(instance => 
  instance.BoundingBox && person.BoundingBox && 
  isInsideBox(instance.BoundingBox, person.BoundingBox)
);
```

**Resultado:**
- ‚úÖ Boxes dibujados correctamente
- ‚úÖ EPPs solo en personas correctas
- ‚úÖ Detecci√≥n h√≠brida funcional
- ‚úÖ Aplicaci√≥n operativa

**Archivos modificados:**
- `/lambda-deteccion-seguridad/lambda_nodeJS/lambda-epi-function/index.mjs`

**Despliegue:**
- ‚úÖ Lambda actualizada: 2025-11-01T22:58:38Z

**Lecciones aprendidas:**
- IoU (Intersection over Union) no es apropiado para este caso
- Verificaci√≥n simple del centro funciona mejor
- Seguir la l√≥gica de EPPs nativos es el enfoque correcto

---

### ‚úÖ v2.8.0 (MINOR) - 03/11/2025
**Mejoras UX: Badges colores + analysisId + Formulario autocompletado**
- ‚úÖ Badges de EPP con colores seg√∫n estado:
  - Verde: Cumple (‚â• umbral)
  - Amarillo: Detectado pero bajo umbral
  - Rojo: No detectado
- ‚úÖ ID √∫nico de an√°lisis (analysisId UUID) visible en resumen y PDF
- ‚úÖ Formulario de contacto autocompletado con datos del perfil de usuario
- ‚úÖ Mensaje prellenado al reportar error desde an√°lisis

**Problema resuelto:**
- Usuario sol√≠cito mejoras visuales para diferenciar estados de EPP
- Necesidad de ID √∫nico para rastrear an√°lisis espec√≠ficos
- Formulario de contacto requer√≠a llenar datos manualmente

**Soluci√≥n implementada:**
- Badges con colores distintivos:
  - `bg-green-500 text-white`: Cumple (EPP detectado ‚â• umbral)
  - `bg-yellow-500 text-white`: Bajo umbral (EPP detectado < umbral)
  - `bg-red-500 text-white`: No detectado (EPP no encontrado)
- UUID generado con `uuidv4()` al crear an√°lisis
- Formulario ContactModal recibe `userProfile` como prop
- Autocompletado de nombre y email desde perfil

**Archivos modificados:**
- `/epi-dashboard/src/components/ImageComparison.tsx` - Badges colores en tabla
- `/epi-dashboard/src/App.tsx` - analysisId UUID + pasar userProfile a ContactModal
- `/epi-dashboard/src/utils/pdfGenerator.ts` - analysisId en PDF
- `/epi-dashboard/src/components/ContactModal.tsx` - Autocompletado desde userProfile
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.0

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (03/11/2025)

**Estructura analysisResult actualizada:**
```javascript
{
  analysisId: 'uuid-v4-string',
  timestamp: Date.now(),
  imageUrl: '...',
  selectedEPPs: [...],
  ProtectiveEquipment: [...],
  Summary: {...},
  aiSummary: '...'
}
```

**Badges en tabla:**
- No evaluable: `bg-gray-100 text-gray-600` (‚ö†Ô∏è)
- No detectado: `bg-red-500 text-white` (‚ùå)
- Cumple: `bg-green-500 text-white` (‚úÖ)
- Bajo umbral: `bg-yellow-500 text-white` (‚ö†Ô∏è)

---

### ‚úÖ v2.8.1 (PATCH) - 04/11/2025
**Fix: 10 correcciones UX, PDF y Resumen IA**
- ‚úÖ Eliminada secci√≥n m√©todos de detecci√≥n EPP del paso 3 del asistente
- ‚úÖ Badges de colores en EPPs seleccionados (verde/amarillo/rojo seg√∫n estado)
- ‚úÖ analysisId UUID visible inmediatamente en resumen de an√°lisis
- ‚úÖ PDF: Confianza m√≠nima corregida (ya no muestra undefined)
- ‚úÖ PDF: An√°lisis detallado sincronizado con tabla frontend (amarillo para bajo umbral)
- ‚úÖ PDF: Imagen analizada centrada en la p√°gina
- ‚úÖ PDF: Texto resumen IA con maxWidth para mejor legibilidad
- ‚úÖ Resumen IA menciona EPPs bajo umbral con recomendaciones
- ‚úÖ Historial: Badge de nivel de confianza visible
- ‚úÖ Historial: analysisId duplicado eliminado

**Problemas resueltos:**
- Usuario reportaba que EPPs seleccionados no mostraban estado visual
- analysisId no era visible al terminar el an√°lisis
- PDF mostraba "undefined" en confianza m√≠nima
- PDF no coincid√≠a con tabla del frontend (faltaba amarillo)
- Imagen en PDF no estaba centrada
- Resumen IA no mencionaba EPPs detectados bajo umbral
- Historial no mostraba nivel de confianza claramente
- analysisId aparec√≠a duplicado en historial

**Soluci√≥n implementada:**

1. **EPPs seleccionados con badges:**
```typescript
const badgeColor = !detected ? 'bg-red-500 text-white' : 
                 meetsThreshold ? 'bg-green-500 text-white' : 'bg-yellow-500 text-white';
```

2. **PDF confianza m√≠nima:**
```typescript
${analysisData.MinConfidence || analysisData.Summary?.minConfidence || 75}%
```

3. **PDF imagen centrada:**
```typescript
const imgX = (pageWidth - imgWidth) / 2;
pdf.addImage(base64, 'JPEG', imgX, yPosition, imgWidth, imgHeight);
```

4. **PDF estado "Bajo umbral" (amarillo):**
```typescript
pdf.setTextColor(251, 191, 36); // Amarillo
pdf.text(`Bajo umbral ${eppConfidence.toFixed(0)}%`, 165, yPosition);
```

5. **Resumen IA con EPPs bajo umbral:**
```typescript
summary += `**‚ö†Ô∏è EPP detectados pero bajo el umbral de ${MinConfidence}%**: ${belowNames}\n`;
summary += `**üîç Recomendaciones para mejorar la detecci√≥n:**\n`;
```

6. **Historial con badge de confianza:**
```typescript
<span className="inline-flex px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-800">
  {analysis.MinConfidence || 75}% confianza
</span>
```

**Archivos modificados:**
- `/epi-dashboard/src/components/GuidedAnalysisWizard.tsx` - Eliminado EPPDetectionInfo
- `/epi-dashboard/src/App.tsx` - Badges colores EPPs + historial mejorado + resumen IA completo
- `/epi-dashboard/src/utils/pdfGenerator.ts` - Confianza fix + imagen centrada + estado amarillo
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.1

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (04/11/2025)

**Badges actualizados:**
- No detectado: `bg-red-500 text-white` ‚ùå
- Bajo umbral: `bg-yellow-500 text-white` ‚ö†Ô∏è (NUEVO)
- Cumple: `bg-green-500 text-white` ‚úÖ
- No evaluable: `bg-gray-100 text-gray-600` ‚ö†Ô∏è

---

### ‚úÖ v2.8.2 (PATCH) - 04/11/2025
**Fix: 4 correcciones cr√≠ticas UX y PDF**
- ‚úÖ analysisId visible al inicio del resumen (antes de tarjetas de estad√≠sticas)
- ‚úÖ PDF an√°lisis detallado replica tabla frontend (FOOT_COVER con LEFT_FOOT/RIGHT_FOOT)
- ‚úÖ analysisId duplicado eliminado en vista de informe desde historial
- ‚úÖ Lambda Bedrock corregida (mapeo FOOT_COVER completo)

**Problemas resueltos:**
- analysisId no era visible al inicio del resumen en modo guiado
- PDF no mostraba calzado en an√°lisis detallado (faltaba LEFT_FOOT/RIGHT_FOOT en mapeo)
- analysisId aparec√≠a duplicado en la vista de informe desde historial
- Lambda Bedrock no mencionaba calzado bajo umbral (mapeo incompleto)

**Soluci√≥n implementada:**

1. **analysisId al inicio del resumen:**
```typescript
{results.analysisId && (
  <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
    <p className="text-xs font-semibold text-blue-700 mb-1">üéØ ID de An√°lisis:</p>
    <p className="text-sm font-mono text-blue-900">{results.analysisId}</p>
  </div>
)}
```

2. **PDF FOOT_COVER completo:**
```typescript
const eppToParts: any = {
  'FOOT_COVER': ['FOOT', 'LEFT_FOOT', 'RIGHT_FOOT'],
  // ...
};
```

3. **analysisId duplicado eliminado:**
```typescript
// Eliminada secci√≥n duplicada en vista de informe
<div className="text-sm text-gray-500 mb-4">
  <p>üìÖ Fecha: {new Date(results.timestamp).toLocaleString()}</p>
</div>
```

4. **Lambda Bedrock actualizada:**
```python
'FOOT_COVER': ['FOOT', 'LEFT_FOOT', 'RIGHT_FOOT']
```

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx` - analysisId al inicio + duplicado eliminado
- `/epi-dashboard/src/utils/pdfGenerator.ts` - FOOT_COVER mapeo completo
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.2
- `bedrock-summary-lambda.py` - Mapeo FOOT_COVER corregido

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (04/11/2025)
- ‚úÖ Lambda bedrock-summary actualizada (04/11/2025)

---

### ‚úÖ v2.8.3 (PATCH) - 04/11/2025
**Fix: MinConfidence ahora se guarda correctamente en DynamoDB**
- ‚úÖ Campo MinConfidence agregado expl√≠citamente al guardar an√°lisis
- ‚úÖ Tarjeta naranja en informe desde historial ahora muestra el valor correcto

**Problema resuelto:**
- En el informe accedido desde historial, la tarjeta de "Confianza M√≠nima" solo mostraba "%" sin el n√∫mero
- Causa ra√≠z: El campo `MinConfidence` no se estaba guardando expl√≠citamente en el objeto `analysisResult`
- La Lambda no devuelve `MinConfidence` en su respuesta, por lo que debe agregarse manualmente

**Soluci√≥n implementada:**

1. **handleUpload (L√≠nea 672):**
```typescript
const analysisResult = { 
  ...res.data, 
  analysisId, 
  timestamp: Date.now(), 
  imageUrl, 
  selectedEPPs: epiItems,
  MinConfidence: minConfidence  // AGREGADO
};
```

2. **handleUploadWithFile (L√≠nea 1003):**
```typescript
const analysisResult = { 
  ...res.data, 
  analysisId, 
  timestamp: Date.now(), 
  imageUrl: `...`, 
  selectedEPPs: uploadEpiItems,
  MinConfidence: uploadMinConfidence  // AGREGADO
};
```

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx` - MinConfidence agregado en 2 ubicaciones
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.3

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (04/11/2025)

**Nota:** Los an√°lisis antiguos sin MinConfidence seguir√°n mostrando solo "%", pero todos los nuevos an√°lisis guardar√°n el valor correctamente.

---

## üêõ BUGS PENDIENTES - v2.8.4

### Sin bugs pendientes

‚úÖ **Todos los bugs identificados han sido resueltos**

---

## üêõ BUGS CORREGIDOS (v2.8.1)

### ‚ùå 1. **Secci√≥n m√©todos de detecci√≥n EPP duplicada**
**Ubicaci√≥n:** Paso 3 del asistente de an√°lisis
**Problema:** Se menciona y aclara los m√©todos de detecci√≥n de EPP en una secci√≥n que debe eliminarse
**Soluci√≥n:** Eliminar apartado de m√©todos de detecci√≥n del paso 3
**Archivo:** `/epi-dashboard/src/components/GuidedAnalysisWizard.tsx`

#### 2. **EPPs seleccionados sin badges de colores**
**Ubicaci√≥n:** Resumen del an√°lisis (inicio)
**Problema:** Los elementos EPP seleccionados no tienen badges de colores seg√∫n estado
**Soluci√≥n:** Aplicar misma l√≥gica de badges (verde/amarillo/rojo) a EPPs seleccionados
**Archivo:** `/epi-dashboard/src/App.tsx`

#### 3. **analysisId no visible al terminar an√°lisis**
**Ubicaci√≥n:** Resumen del an√°lisis
**Problema:** El ID √∫nico de an√°lisis no se muestra apenas termina el an√°lisis
**Soluci√≥n:** Mostrar analysisId en el resumen inmediatamente despu√©s del an√°lisis
**Archivo:** `/epi-dashboard/src/App.tsx`

#### 4. **PDF muestra confianza m√≠nima como undefined**
**Ubicaci√≥n:** PDF exportado
**Problema:** El PDF no muestra la confianza m√≠nima seteada, dice "undefined"
**Soluci√≥n:** Usar `analysisData.MinConfidence || minConfidence` en pdfGenerator
**Archivo:** `/epi-dashboard/src/utils/pdfGenerator.ts`

#### 5. **PDF an√°lisis detallado no coincide con tabla**
**Ubicaci√≥n:** PDF - An√°lisis detallado por persona
**Problema:** El PDF no muestra lo mismo que se ve en la tabla del frontend
**Soluci√≥n:** Sincronizar l√≥gica de tabla PDF con tabla frontend (badges colores)
**Archivo:** `/epi-dashboard/src/utils/pdfGenerator.ts`

#### 6. **Imagen analizada en PDF no centrada**
**Ubicaci√≥n:** PDF - Imagen analizada
**Problema:** La imagen analizada no est√° centrada en el PDF
**Soluci√≥n:** Calcular posici√≥n X para centrar imagen: `(pageWidth - imgWidth) / 2`
**Archivo:** `/epi-dashboard/src/utils/pdfGenerator.ts`

#### 7. **Resumen IA no justificado en PDF**
**Ubicaci√≥n:** PDF - Cuerpo del informe t√©cnico
**Problema:** El texto del resumen inteligente no est√° justificado
**Soluci√≥n:** Aplicar `pdf.text(..., { align: 'justify' })` al resumen IA
**Archivo:** `/epi-dashboard/src/utils/pdfGenerator.ts`

#### 8. **Resumen IA no menciona EPPs bajo umbral**
**Ubicaci√≥n:** Resumen inteligente de IA
**Problema:** Solo menciona EPPs cumplientes, no menciona los detectados bajo umbral
**Soluci√≥n:** Agregar secci√≥n en resumen IA para EPPs detectados pero bajo umbral
**Archivo:** `/epi-dashboard/src/App.tsx` - funci√≥n `generateLocalAISummary`

#### 9. **Nivel de confianza no visible en historial**
**Ubicaci√≥n:** Historial de an√°lisis
**Problema:** El nivel de confianza no se divisa en el historial
**Soluci√≥n:** Mostrar badge con nivel de confianza en cada an√°lisis del historial
**Archivo:** `/epi-dashboard/src/App.tsx`

#### 10. **analysisId duplicado en historial**
**Ubicaci√≥n:** Historial de an√°lisis
**Problema:** El ID de an√°lisis se ve repetido en 2 ubicaciones diferentes
**Soluci√≥n:** Eliminar una de las ubicaciones duplicadas del analysisId
**Archivo:** `/epi-dashboard/src/App.tsx`

---

### ‚úÖ v2.8.6 (PATCH) - 02/11/2025
**Fix: Dashboard an√°lisis recientes ordenados + PDF cumplimiento correcto + p√°rrafos justificados**
- ‚úÖ Dashboard: An√°lisis recientes ahora usa `.slice(0, 6)` en lugar de `.slice(-6).reverse()`
- ‚úÖ PDF: Recibe `compliantCount` calculado con calculateCompliance como par√°metro
- ‚úÖ PDF: Usa cumplimiento correcto en tarjeta de cumplientes y porcentaje
- ‚úÖ PDF: P√°rrafos del resumen IA justificados para mejor presentaci√≥n

**Problema resuelto:**
- Dashboard mostraba an√°lisis recientes desactualizados (tomaba √∫ltimos 6 e invert√≠a)
- PDF mostraba cumplimiento incorrecto (usaba Summary.compliant de la Lambda)
- PDF ten√≠a texto del resumen IA alineado a la izquierda

**Soluci√≥n implementada:**
- Dashboard toma primeros 6 de analysisHistory ya ordenado por timestamp descendente
- PDF calcula compliantCount con calculateCompliance antes de generar
- PDF usa align: 'justify' en resumen IA

**Archivos modificados:**
- `/epi-dashboard/src/components/Dashboard.tsx` - Ordenamiento an√°lisis recientes
- `/epi-dashboard/src/utils/pdfGenerator.ts` - compliantCount + justificado
- `/epi-dashboard/src/App.tsx` - Pasar compliantCount al PDF
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.6

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (02/11/2025)

---

### ‚úÖ v2.8.5 (PATCH) - 02/11/2025
**Fix: Cumplimiento correcto en historial/dashboard + ordenamiento por timestamp**
- ‚úÖ Funci√≥n calculateCompliance recalcula cumplimiento basado en EPPs seleccionados y umbral
- ‚úÖ Historial muestra cumplimiento correcto (usa calculateCompliance)
- ‚úÖ Dashboard muestra cumplimiento correcto (usa calculateCompliance)
- ‚úÖ analysisHistory ordenado por timestamp descendente (m√°s reciente primero)
- ‚úÖ Dashboard muestra an√°lisis recientes actualizados correctamente
- ‚úÖ Consistencia total entre Dashboard e Historial

**Problema resuelto:**
- Lambda devuelve `Summary.compliant` basado solo en EPPs nativos (HEAD_COVER, HAND_COVER, FACE_COVER)
- Usuario selecciona EPPs h√≠bridos (EYE_COVER) que no se consideraban en el c√°lculo
- Dashboard mostraba an√°lisis desactualizados por falta de ordenamiento
- Historial y Dashboard mostraban "0 cumplientes" cuando deber√≠a ser "3 cumplientes"

**Soluci√≥n implementada:**
- calculateCompliance calcula cumplimiento real: persona cumple si tiene TODOS los EPPs seleccionados con confianza ‚â• umbral
- Ordenamiento expl√≠cito por timestamp en fetchAnalysisData
- Dashboard recibe calculateCompliance como prop y lo usa en estad√≠sticas y lista reciente

**Archivos modificados:**
- `/epi-dashboard/src/App.tsx` - calculateCompliance + ordenamiento + prop a Dashboard
- `/epi-dashboard/src/components/Dashboard.tsx` - Usa calculateCompliance
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.5

**Despliegues:**
- ‚úÖ Frontend desplegado v√≠a Amplify (02/11/2025)

**Nota:** Esta versi√≥n corrige el commit 7d6c574 que se hizo sin versionar

---

**√öltima actualizaci√≥n:** 02/11/2025 - v2.8.6 DESPLEGADO
**Versi√≥n actual:** v2.8.6
**Estado:** ‚úÖ Estable - Dashboard, Historial y PDF consistentes
**Bugs pendientes:** 0
**Backups:** ‚úÖ Local + Nube configurados


---

### ‚úÖ v2.8.11 (PATCH) - 02/11/2025
**Fix CR√çTICO: Lambda genera presignedUrl para TODOS los tipos de detecci√≥n**

**Problema reportado:**
- Detecci√≥n de objetos (label_detection) tiraba error: "cannot read properties of undefined"
- Mismo error ocurr√≠a con face_detection y text_detection
- Solo ppe_detection funcionaba correctamente

**Causa ra√≠z identificada:**
- Lambda rekognition-processor solo generaba presignedUrl para `ppe_detection`
- Otros tipos de detecci√≥n (label_detection, text_detection, face_detection) devolv√≠an datos directamente sin presignedUrl
- Frontend SIEMPRE espera presignedUrl para obtener JSON desde S3 (l√≠neas 626-640 de App.tsx)
- Sin presignedUrl ‚Üí error "cannot read properties of undefined (reading 'protocol')"

**An√°lisis del flujo correcto:**
1. Frontend env√≠a imagen a Lambda rekognition-processor
2. Lambda procesa imagen con Rekognition
3. Lambda guarda resultados en S3 como JSON (`web/${baseName}_${timestamp}.json`)
4. Lambda genera presignedUrl usando `getSignedUrl` de AWS SDK
5. Lambda devuelve respuesta CON presignedUrl incluido
6. Frontend hace `axios.get(presignedUrl)` para obtener JSON con resultados
7. Frontend procesa y muestra resultados

**Problema detectado en Lambda:**
```javascript
// ‚ùå INCORRECTO (label_detection, text_detection, face_detection)
case 'label_detection':
  detectionResult = await rekognition.send(new DetectLabelsCommand(params));
  return {
    Labels: detectionResult.Labels,
    Summary: { totalLabels: detectionResult.Labels.length },
    DetectionType: 'label_detection',
    // ‚ùå FALTA presignedUrl
  };

// ‚úÖ CORRECTO (ppe_detection)
case 'ppe_detection':
  // ... procesamiento ...
  await s3.send(new PutObjectCommand({ /* guardar en S3 */ }));
  const presignedUrl = await getSignedUrl(s3, new GetObjectCommand({ /* ... */ }));
  return {
    ...resultData,
    presignedUrl,  // ‚úÖ presignedUrl incluido
  };
```

**Soluci√≥n implementada:**
- Modificada Lambda rekognition-processor para que TODOS los tipos de detecci√≥n:
  1. Guarden resultados en S3 como JSON
  2. Generen presignedUrl usando `getSignedUrl`
  3. Devuelvan respuesta con presignedUrl incluido

**C√≥digo corregido:**
```javascript
case 'label_detection':
  detectionResult = await rekognition.send(new DetectLabelsCommand(params));
  
  const labelResultData = {
    Labels: detectionResult.Labels,
    Summary: { totalLabels: detectionResult.Labels.length, minConfidence },
    DetectionType: 'label_detection',
  };
  
  // Guardar resultado en S3
  const labelBaseName = filename.split('/').pop().split('.')[0];
  const labelJsonKey = `web/${labelBaseName}_${Date.now()}.json`;
  
  await s3.send(new PutObjectCommand({
    Bucket: bucket,
    Key: labelJsonKey,
    Body: JSON.stringify(labelResultData),
    ContentType: 'application/json',
  }));
  
  // Generar presigned URL
  const labelPresignedUrl = await getSignedUrl(s3, new GetObjectCommand({
    Bucket: bucket,
    Key: labelJsonKey,
  }), { expiresIn: 3600 });
  
  return {
    ...labelResultData,
    presignedUrl: labelPresignedUrl,  // ‚úÖ presignedUrl incluido
  };
```

**Tipos de detecci√≥n corregidos:**
- ‚úÖ face_detection: Ahora guarda en S3 y genera presignedUrl
- ‚úÖ label_detection: Ahora guarda en S3 y genera presignedUrl
- ‚úÖ text_detection: Ahora guarda en S3 y genera presignedUrl
- ‚úÖ ppe_detection: Ya funcionaba correctamente

**Archivos modificados:**
- `/tmp/aws-toolkit-vscode/lambda/us-east-1/rekognition-processor/index.mjs` - Todos los tipos de detecci√≥n
- `/epi-dashboard/src/version.ts` - Actualizado a v2.8.11

**Despliegues:**
- ‚úÖ Lambda rekognition-processor actualizada (02/11/2025 21:06:32 UTC)
- ‚úÖ Frontend v2.8.11 pusheado a GitHub (Amplify auto-deploy)

**Estructura correcta de respuesta Lambda (TODOS los tipos):**
```javascript
{
  // Datos espec√≠ficos del tipo de detecci√≥n
  Labels: [...],              // para label_detection
  Faces: [...],               // para face_detection
  TextDetections: [...],      // para text_detection
  ProtectiveEquipment: [...], // para ppe_detection
  
  // Campos comunes
  Summary: { ... },
  DetectionType: 'label_detection',
  presignedUrl: 'https://rekognition-gcontreras.s3...'  // ‚úÖ OBLIGATORIO
}
```

**Lecciones aprendidas:**
1. ‚ö†Ô∏è **Flujo unificado:** TODOS los tipos de detecci√≥n deben seguir el mismo flujo (guardar en S3 + presignedUrl)
2. ‚ö†Ô∏è **Frontend espera consistencia:** El frontend est√° dise√±ado para obtener resultados desde S3 usando presignedUrl
3. ‚ö†Ô∏è **No asumir diferencias:** Aunque los tipos de detecci√≥n son diferentes, el flujo de respuesta debe ser id√©ntico
4. ‚ö†Ô∏è **Documentar estructura:** La estructura de respuesta de la Lambda debe estar documentada y ser consistente
5. ‚ö†Ô∏è **Revisar incidente v2.6.17:** Este mismo problema ya se hab√≠a resuelto para ppe_detection, debi√≥ aplicarse a todos los tipos

**Relaci√≥n con incidente v2.6.17:**
- v2.6.17 resolvi√≥ el problema de presignedUrl para ppe_detection
- v2.8.11 extiende la soluci√≥n a TODOS los tipos de detecci√≥n
- Ambos incidentes tienen la misma causa ra√≠z: Lambda no genera presignedUrl
- Ambos incidentes tienen la misma soluci√≥n: Guardar en S3 + generar presignedUrl

**Tiempo de resoluci√≥n:** ~30 minutos
**Impacto:** Detecci√≥n de objetos/rostros/texto completamente inoperativa
**Estado final:** ‚úÖ Todos los tipos de detecci√≥n funcionando correctamente

---

**√öltima actualizaci√≥n:** 02/11/2025 - v2.8.11 DESPLEGADO
**Versi√≥n actual:** v2.8.11
**Estado:** ‚úÖ Estable - Todos los tipos de detecci√≥n funcionales
**Bugs pendientes:** 0
